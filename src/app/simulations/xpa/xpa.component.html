<app-simulation-container [simulation-body]="simulation" [simulation-definition]="definition"
    [simulation-controls]="controls" [content-layout-mode]="contentLayoutMode" #container>
</app-simulation-container>

<ng-template #simulation>
    <ng-container *ngIf="isHandset$ | async">
        <ng-container *ngTemplateOutlet="actions"></ng-container>
    </ng-container>
    <div class="simulation-console" *ngIf="container.simulation$ | async as simulation">
        <div class="console-header">
            <img src="assets/bitcoin-btc-logo.svg">
            <span>
                {{simulation.title}}
            </span>
        </div>
        <div class="console-data">
            <div *ngFor="let participant of participants$ | async" class="xpa-participant">
                <h3>{{participant.title}}</h3>
                <div class="xpa-stripes">
                    <span class="non-confirm">{{participant.stripes}}</span>
                    <span class="confirm" *ngIf="participant.leadingStripes">{{participant.leadingStripes}}</span>
                </div>
                <div class="xpa-blocks">
                    <span class="non-confirm">{{participant.blocks}}</span>
                    <span class="confirm" *ngIf="participant.leadingStripes">{{participant.leadingBlocks}}</span>
                </div>
                <div class="xpa-details">
                    <div class="xpa-count"><span>Angriffsdauer</span><span class="confirm">{{participant.minedBlocks}} / {{blocksToComplete}}</span></div>
                    <div class="xpa-left"><span>Vorsprung</span><span class="confirm">{{participant.absoluteLead}}</span></div>
                    <div class="xpa-hashrate">
                        <span>HashRate</span>
                        <span class="confirm">{{participant.hashrate.value}} <span class="non-confirm">{{participant.hashrate.unit}}</span></span>
                        
                    </div>
                </div>
            </div>

            <div *ngIf="totalHashRate$ | async as hashRate" class="xpa-participant">
                <div class="xpa-details">
                    <div class="xpa-hashrate">
                        <span>Gesamt HashRate</span>
                        <span class="confirm">{{hashRate.value}} <span class="non-confirm">{{hashRate.unit}}</span></span>                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #controls>
    <mat-expansion-panel expanded="false">
        <mat-expansion-panel-header>
            <mat-panel-title>
                <h2>Input</h2>
            </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="parameters">
            <form [formGroup]="inputs">
                <mat-form-field appearance="fill">
                    <mat-label>Maximale Angriffsdauer <i>[in Blöcken]</i></mat-label>
                    <input matInput type="number" formControlName="blocksToComplete" [readonly]="isExecuting"/>
                    <label class="validation-error" *ngIf="!isExecuting && !inputs.controls['blocksToComplete'].valid">
                        <span>{{getErrors('blocksToComplete')}}</span>
                    </label>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Angriffspower <i>[in Prozent]</i></mat-label>
                    <input matInput type="number" formControlName="attackingPower" [readonly]="isExecuting"/>
                    <label class="validation-error" *ngIf="!isExecuting && !inputs.controls['attackingPower'].valid">
                        <span>{{getErrors('attackingPower')}}</span>
                    </label>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Vorsprung Angriff <i>[in Blöcken]</i></mat-label>
                    <input matInput type="number" formControlName="preminedBlocks" [readonly]="isExecuting"/>
                    <label class="validation-error" *ngIf="!isExecuting && !inputs.controls['preminedBlocks'].valid">
                        <span>{{getErrors('preminedBlocks')}}</span>
                    </label>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Abbruch Angriff <i>[nach x Blöcken]</i></mat-label>
                    <input matInput type="number" formControlName="cancelAttack" [readonly]="isExecuting"/>
                    <label class="validation-error" *ngIf="!isExecuting && !inputs.controls['cancelAttack'].valid">
                        <span>{{getErrors('cancelAttack')}}</span>
                    </label>
                </mat-form-field>
                <mat-form-field appearance="fill">
                    <mat-label>Anzahl Bestätigungen <i>[in Blöcken]</i></mat-label>
                    <input matInput type="number" formControlName="confirmations" [readonly]="isExecuting"/>
                    <label class="validation-error" *ngIf="!isExecuting && !inputs.controls['confirmations'].valid">
                        <span>{{getErrors('confirmations')}}</span>
                    </label>
                </mat-form-field>
            </form>
        </div>
    </mat-expansion-panel>

    <mat-expansion-panel>
        <mat-expansion-panel-header>
            <mat-panel-title>
                <h2>Optionen</h2>
            </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="options">
            <mat-checkbox [(ngModel)]="clearOnStart">
                Clear bei Start
            </mat-checkbox>
        </div>
    </mat-expansion-panel>

    <ng-container *ngTemplateOutlet="actions"></ng-container>
</ng-template>

<ng-template #definition>
    <app-xpa-definition></app-xpa-definition>
</ng-template>


<ng-template #actions>
    <div class="actions">
        <button mat-button (click)="start()" [disabled]="isExecuting || preminedBlocks >= confirmations">Start</button>
        <button mat-button (click)="stop()" [disabled]="!isExecuting">Stop</button>
        <button mat-button (click)="clear()" [disabled]="isExecuting">Clear</button>
        <span *ngIf="totalAmountBlocks$ | async as totalAmountBlocks">
            <span *ngIf="totalAmountBlocks > 0">Simulation {{isExecuting ? 'gestartet...' : 'beendet.'}}<br /></span>            
        </span>
        <div *ngIf="isExecuting">
            <mat-progress-bar [mode]="'indeterminate'">
            </mat-progress-bar>
        </div>
        <div *ngIf="!isExecuting">
            <span>
                Bereit für Simulation.
            </span>
            <mat-progress-bar [mode]="'determinate'">
            </mat-progress-bar>
        </div>
    </div>
</ng-template>